<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>보장 점검 안내</title>
  <link rel="stylesheet" href="{{ css_path }}" />
</head>

<body>
  <div class="preview-viewport">
    <div class="page">
      <div class="topband"></div>

      <header class="header">
        <div class="header-left">
          <div class="label">LIFE REPORT</div>

          <div class="title">
            {{ customer.name }} 고객님을 위한<br/>
            <strong>{{ customer.age_band }} · {{ customer.gender }}</strong> 보장 점검 안내
          </div>

          <div class="subtitle">
            보험 가입 여부보다 “현재 기준 최소 구조”가 갖춰져 있는지 점검이 중요합니다.
          </div>

          <div class="meta-inline">
            기준연도 {{ stats.base_year }} · {{ stats.source }} · v{{ version }}
          </div>
        </div>

        <div class="header-right">
          <div class="logo">
            {% if logo_data_uri %}
              <img src="{{ logo_data_uri }}" alt="Mirae Asset" />
            {% endif %}
          </div>
        </div>
      </header>

      <section class="section">
        <h2 class="section-title">요약</h2>
        <ul class="bullets">
          {% for line in segment.summary_lines %}
            <li>{{ line }}</li>
          {% endfor %}
        </ul>
      </section>

      <section class="section">
        <h2 class="section-title">현황 통계 예시</h2>
        <div class="cards">
          {% for card in stats.cards %}
            <div class="card">
              <div class="card__title">{{ card.title }}</div>
              <div class="card__value">{{ card.value }}</div>
            </div>
          {% endfor %}
        </div>
        <div class="note">
          * 위 내용은 동일 연령·성별 집단의 통계 기반 요약이며, 개인별 상황에 따라 달라질 수 있습니다.
        </div>
      </section>

      <section class="section">
        <div class="grid2">
          <div>
            <h2 class="section-title">점검 질문</h2>
            <ol class="questions">
              {% for q in segment.gap_questions %}
                <li>{{ q }}</li>
              {% endfor %}
            </ol>
          </div>    

          <div>
            <h2 class="section-title">필요 보장 구조(개요)</h2>
            <div class="table">
              <div class="row head">
                <div class="cell col1">보장 영역</div>
                <div class="cell col2">점검이 필요한 이유</div>
              </div>
              {% for r in structure_rows %}
              <div class="row">
                <div class="cell col1">{{ r.area }}</div>
                <div class="cell col2">{{ r.reason }}</div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>    
      </section>
      
      <section class="cta">
        <div class="cta__headline">확인하고 싶으시면, 한 번에 점검해보시죠.</div>
        <div class="cta__body">{{ segment.cta }}</div>
      </section>

      <section class="planner">
        <div class="planner-box">
          <div class="planner-title">상담 및 보장 점검 문의</div>
          <div class="planner-name">{{ planner.name }}</div>
          <div class="planner-org">{{ planner.org_display }}</div>
          <div class="planner-phone">연락처 : {{ planner.phone_display }}</div>
          {% if planner.email %}
            <div class="planner-email">이메일 : {{ planner.email }}</div>
          {% endif %}
        </div>
      </section>

      <footer class="footer">
        <div class="footer__disclaimer">{{ footer.disclaimer }}</div>
        <div class="footer__legal">{{ footer.legal_note }}</div>
      </footer>
    </div>
  </div> 

  <script>
  (function () {
    const viewport = document.querySelector(".preview-viewport");
    const page = document.querySelector(".page");
    if (!viewport || !page) return;

    function getScale() {
      // viewport 안에서 A4 page를 "가로 기준으로"만 축소
      const vw = viewport.clientWidth;
      const pw = page.getBoundingClientRect().width; // transform 전 기준 폭
      if (!pw) return 1;
      return Math.min(1, vw / pw);
    }

    function fitAndReport() {
      // 1) scale 적용
      const scale = getScale();
      page.style.transform = `scale(${scale})`;
      page.style.transformOrigin = "top left";

      // 2) viewport 높이 정확히 계산 (scrollHeight는 transform 반영 안 하는 경우가 있어 rect 사용)
      //    getBoundingClientRect()는 transform 적용 후 크기를 반영함
      const rect = page.getBoundingClientRect();
      const targetH = Math.ceil(rect.height);

      viewport.style.height = targetH + "px";

      // 3) Streamlit iframe 높이를 컨텐츠에 맞춰 자동 조절 (빈 여백 제거 핵심)
      try {
        window.parent.postMessage(
          { type: "streamlit:setFrameHeight", height: targetH + 20 },
          "*"
        );
      } catch (e) {}
    }

    // 레이아웃/폰트/이미지 로드로 높이 변하는 케이스까지 커버
    const ro = new ResizeObserver(fitAndReport);
    ro.observe(viewport);
    ro.observe(page);

    window.addEventListener("load", fitAndReport);
    window.addEventListener("resize", fitAndReport);

    // 폰트 로딩 이후 재계산(폰트가 PDF/미리보기 느낌 차이 만들던 핵심 포인트)
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(fitAndReport).catch(() => {});
    }

    // 이미지(로고) 로드 후에도 재계산
    const imgs = page.querySelectorAll("img");
    imgs.forEach(img => {
      if (!img.complete) img.addEventListener("load", fitAndReport, { once: true });
    });

    // 최초 1회
    fitAndReport();
  })();
  </script>

</body>
</html>
